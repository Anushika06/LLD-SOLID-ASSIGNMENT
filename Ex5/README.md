# **Ex5 — LSP Refactor: File Exporter Hierarchy**

## **1. Overview**

This exercise focuses on refactoring a **File Export System** to comply with the **Liskov Substitution Principle (LSP)**. The system provides a unified interface to export student report data into various formats like PDF, CSV, JSON, and XML.

---

## **2. Problem in the Original Design**

The initial implementation suffered from several "Behavioral Smells" where subclasses were not true substitutes for their parent class:

* **Tightening Preconditions:** The `PdfExporter` threw an exception if the content length exceeded 20 characters. A caller expecting a general `Exporter` would not know to handle this arbitrary limit.
* **Semantic Corruption:** The `CsvExporter` silently replaced commas and newlines with spaces to avoid breaking the CSV structure. This resulted in data loss that the caller was never notified of.
* **Inconsistent Contracts:** The `JsonExporter` handled `null` inputs by returning a surprise empty byte array, while other exporters might have crashed or behaved differently.
* **Fragile Callers:** Because the subclasses behaved inconsistently, the `Main` class had to use `try-catch` blocks and "safe" wrappers to protect itself from specific subclass failures.

This violated the **Liskov Substitution Principle**:

> *Subtypes must be substitutable for their base types without altering the correctness of the program.*

---

## **3. Refactoring Objective**

The goal of the refactor was:
✔ **Establish a Strong Base Contract:** Define exactly what an `Exporter` can and cannot do.

✔ **Uniform Validation:** Move common validation logic to the base class to ensure all exporters have identical preconditions.

✔ **Template Method Pattern:** Use a template method (`export`) to handle the contract and an abstract method (`successfulExport`) for format-specific logic.

✔ **Predictable Output:** Ensure that data integrity is maintained (e.g., using proper CSV escaping instead of destructive replacement).

---

## **4. Refactored Design**

The hierarchy was redesigned to enforce a "Design by Contract" approach.

### **Exporter (Base Class)**

**Responsibility:** Defines and enforces the contract for all exports.

* **Template Method (`export`):** This is now a `final` method. It performs mandatory null checks on the request, title, and body.
* **Contract Enforcement:** It guarantees that if `successfulExport` is reached, the data is valid and present.

---

### **Specific Exporters (Pdf, Csv, Json, Xml)**

**Responsibility:** Handle the actual byte-encoding of the validated data.

* **PdfExporter:** Now handles any length of content, removing the arbitrary 20-character limit that broke substitutability.
* **CsvExporter:** Instead of deleting commas, it properly escapes content (wrapping in quotes) to maintain data integrity.
* **XmlExporter:** A new addition that proves the system is now **Open/Closed** as well.

---

### **ExportResult**

**Responsibility:** A unified response object that includes the content type and the generated bytes.

* Added a `toString()` helper to standardize how results are logged in `Main`.

---

## **5. Key Improvements**

### **Liskov Substitution Compliance**

Any instance of `Exporter` can now be swapped with another without the caller needing to worry about hidden character limits or surprise null-handling behaviors. The `Main` class no longer needs complex error-handling logic for standard operations.

### **Elimination of Data Corruption**

By implementing proper CSV escaping (`replace("\"", "\"\"")`), the system now honors the **Postcondition** that the exported data must represent the original input accurately.

### **Template Method Pattern**

By moving validation logic to the `final` method in the base class, we prevent subclasses from "forgetting" to validate or implementing validation inconsistently.

---

## **6. LSP Justification**

The refactor adheres to LSP because:
✔ **Preconditions are not strengthened:** All exporters accept the same valid `ExportRequest`.

✔ **Postconditions are not weakened:** All exporters return a valid `ExportResult` with accurate data.

✔ **Invariants are preserved:** The state and integrity of the data remain consistent across all implementations.

---

## **7. Behavioral Integrity**

✔ The output in `Main` shows "OK" for all formats.

✔ Data that previously caused the PDF exporter to crash is now handled correctly.

✔ The byte counts accurately reflect the formatted content of each specific file type.

---

## **8. Resulting Benefits**

* **Reliability:** Callers can treat all exporters as a "Black Box" with total confidence.
* **Extensibility:** Adding a new format (like `ExcelExporter`) is safe and predictable.
* **Maintainability:** Validation logic is defined in one place (the base class) rather than being duplicated and potentially diverged across subclasses.

---

## **9. Conclusion**

This refactor corrected a broken inheritance hierarchy. By standardizing the contract and ensuring that subclasses honor the expectations set by the base class, the system has evolved from a collection of "surprising" objects into a robust, substitutable framework.